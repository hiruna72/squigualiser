from bokeh.plotting import figure, show, output_file, save
from bokeh.models import Span, BoxAnnotation, HoverTool, ColumnDataSource, Label, LabelSet, CustomJS
from bokeh.colors import RGB
import pyslow5
import copy
import argparse

base_color_map = {'A':'limegreen','C':'blue','T':'red','G':'orange'}

parser = argparse.ArgumentParser()
   
parser.add_argument('-s', '--slow5', required='True', help="shows output")
parser.add_argument('-r', '--read', required='True', help="shows output")
parser.add_argument('-o', '--output', required='True', help="shows output")

args = parser.parse_args()
print(f'signal file: {args.slow5}')
print(f'read: {args.read}')
print(f'output file: {args.output}')

read_id = "7a863656-a07d-425b-a3ca-7409a7c14bc1"
moves="1001010101010110101000010100101011011010101000110101010101000101010101001011001011011010101101010100100010110110101010100100101010010010100101010001010110111110101011101001011010101101010001010110101000010010010011010101010101001000010101011010111010111011010110101101001010101011010100000001001011000000100001000101010000010101111010111111010001010110100110110101010010110110101100100101001000110100010101101110110110111011110110110100100101010110110010010010010011000110100001000000000001000001010100001101011011011010101001001001101100101010010101000101101101101111010110101001001011101110111001101101010110111101010010101010000100000001001000000001001010010100010101000011010000100101000100010101101010101010110101010110010101010110111011001010100010011011011011010101010111001101010110111011101111101101010011001001101110101000100101101010111001110010010000101011000001100010101001010010100010000001001010011001010100000001000101010010001000100100010001010100110101000110101101010101010101101010110101001010010100001001101011010101101010101010110101101010101010110010011010101010011101001000000010110000000000000001001010100010100100101101011010100100100101010101001001101011101100011010010101000010101101101010101010101101110110111011000101010110101011010010110011010101101110101101010011000100110110110001001101101101110101110101101011011010100110101011010101010100110100111000101010110111010101001000010000000100101010101010011100010010101011010101010010010010010110110100101010100101101101010101010000100100101001000010100000101101011101011011010100101001010001101101100111001010110000000000"
bases="TACTTCGTTCAGTTACGTATTGCTCCTATAATTGAAGACACTTGTTCTTATACTGCTTTAAGGTATAAAGGAAGAAAAAAAACAGATAATGGCAAATGTTGGTGAAGCCGGGCATGGTGGCAGCCTGTAATTCCAGAACTTAGGGAGGCTGAGGTGGGCAGATCACTTGAGGCCAGGAGTATGAGACCAGCCTGGGCAACATGGTAAAATCCCACCACTACAGAAAAATATAAAAATTAGCCAGGCATGGTGGCGTACACCTGTAATTTTCAGCTACCCAGGAGGCTGAGATGAGAGAATCACTTGTGCCTGGGAGGTCACGGCTGCAGTGAACTGTGATGGCATCATTGCACTGCAGCCTGAGAGACAGAGCAAGCCCCTATCTAGAAAAAAAAAATGTCAGTGAAGATGTGGAGGAATTGGAACCCACATACATTACTGGTGGGAACATAAAATTGTGTAACCATTTTGTTTGGGTATTTTCTTTTCTTGTCATTTAGTGGATTTTTAAAAAATCAAGACGGGGTTTCACTATCTTGCCAGGCTGGTCTTGAATTCCTGAGCTCAAGCCATCCTCCTAGCTGAGCCTCCTGAGTAGCTGGGATTACAGGTGTGAGCCATTGCACCCAACTGAGTATAGCCACGTTAGAAAACATTCTGGCAGTTTCTCAAAAGGCTAAATGTACAGTCATCCTATAATGCAACAATTTCACTCCTAGGCATATGTCCAGAAAAATAAAAATATATG"

# moves="1001011001110001101101101010101010010100001010110011100110101010100100101010010010101101011010110010011000001011101101010110111001101010001010101010010101010101011010110111000000100101111110110101000010100000000000010110100101010110101010010100100001001011010100001010010000000010100001011101011101101011111011100101001100001010010000011000110101010101010101010010110101101010000101010101010101011010110101010101011101010101010101010110000001000001001000100010001001010111010101011011000101011010110101010011010000101010101011011001101010111111011010100110000100011001010100101010100100000001010010101010010100100001000010100101000110101011010100001011011011010110101101010001000011101010010101010110010101010110010100000010101011000101010100100101010000000010100001010101000010010100100001001010000001001000100011000101011010100100101001010101010101010100100110010011011010001011000100000001010101101001010010110100001000101010110110010110110110100000100101001010100101010101010100101010010101101001010101101010110011010101010010100010101010001000010101011001011010101010010100101101011011011010110110100011110101101101111011010101110101010000101001100101011001000101001101010000101010111011110101011101101101010000011010101010101000001000000010010000000000000010101101101101010100101001010101000001001110101010100000101011000101001010010101010111011010110110101010100101001010100100001001100100101011111101110111011010101010101101011011010101101100110001001001011001101001010010010010110100110110110010100010101000001010010010100001010001100101010100100011001010101101000010101001010010100000000000"
# bases="AAAAATATATGTCCACACAAAAACTTGTACAACAATCTTCATAGCAGCATTATTCATAATGACCAATACATGGAATACATGGAAACAACCCAAATATCCACCAACTGATGAACAGATAAACAAAATGCAGTGTGTCTCTACCATGGAATACTGCCATAGAAGGAATGAAATGATACACACTATGACATAAAGGAACTTTGAAAACACTGTGTAAGAGGGAAAAAAATACAAAAGATCACATATTGTACTGTTCTATTTGTCCAGATTAGGCAAATCTATAGTGACAAAAAAATTAATCAATGGTTGCCTAAGGCTGGGGGCAAAGGTAGGTGGGGAGAGTAGGAGGTAGTGGCTAAGGGGTATGGATTTCTCTATAGGGTAATGAAAGGTTCTAAAAGTGACTGTGGTGATCGATGCACAGCTCTGTGAATATTCTAAAACCTACTGAATTGCAGATTTCAATAAATAAAGTGAATGGTATGTGAATATTTTAATAAAGCTATTATTTAAAATAATAATAATAGGGGGCTGGGCACAGGTGGTCATGCCTGTAATCCCAGCACTTTGGGAGGCTGAGGCAGGAGGATCACTTGAGGTCAGGAGTTTGAGCCCAGTCGGAGCAACATGGCAAGATCCCGTCTCTATGATAAAAAATTACCTGGACATGGTGGCACATGTCTGTAGTCCCAGCTACTTGGGAGACTGAAGTGAGAGA"

# moves="1000101010100100101010100110110100101011010101001000000000010010110111111010101110101101101011110110101010101001010111001101010101010101011010111010011001101010111010101110100010010111011010110100010010101101001010010100101011010101010010100001111010010101010101010110100101100010000110101111001010101010110101011101110111011011010110101011010101010101010101010100010101010101010101010010000000000000101001010110101101010101101101110101010000010101110100100101001001001010100110101001101010101010101101001010011001010101010110111010001010010110101010110101010100101001101000010010010101011011010011001000010101000101010101001010001011010101010101010101001010010001000101010101011010110110101111010110101011110110010101010101101010010101011001100101001000010101010110100101100101010100100000100101001010101101001110010101000101010101000000000011100010100010010011010001001010001000010010100100101011001101001101110101000100101010111010000000000110101000000001000000101100001001100000000101010000000010010101101101010111101000000000000100100110101000100010101010110010101011001110101000100001100011010010010000100001010101011101100101010010111010010110101001010100010101010110100000001010101010001101000001101000100010000000000010101000100100000000001000001001001000101001101010101010100110101101011011110011011000101001001010100100100100011001010101011011101011110100110100101001011000000000100000000010001100000000010101010101010101010101010101010101101111010101010000001010111101101010100000101010110010010010101010011001010110101010111011011011011010101010100100101110011000010000000100010000000000"
# bases="GTGAGAGAACCACTTGAGCCCAGGAGTTTGAGGCTACAGTGAACCATGATCATGTCATACTGTAGCCTAAGCAACAGAGCAAGACGCTGTCTCTGAAAGGAAAGAAAACAAATGCAAGTTTTTATCACTTTGTGAGTGGCAGCCAAGTTGGAGGAGAAATAGACAATAATAAAAGAGCACTGAATAATGACAGTGAGTGGCTGGTTAGGCTCAGTTGCTAGCTAAATGGCTTCTAGAAATTCAATAAAGTTACAGCTCTGGGGACAGTCATGTAGTCAAAGAATGAGAGCGAAATTCATTACAATTGCCCATGGTCTTTATTTACATGCCTTCTAGTGAAAAATTCTAAGTGCCTAAACAGCAAGTCTGCAATGATAGCAGCTGTTTATTAAAGACTAAAAAAGAAATGGAGGCCGGGCGTGGTTGTTCACATCTGTACTCCCCTTGAATTTTGGGAGGCTGAGGCAGGCAGATTGCCTGAGGTCAGGAGCTCGGGAGCCTGGCCAACATGGTGAAATCCCATCTCTACTAAAAATACAAAAATTAGCTGGGTATGGTGGCGGGCACCTGTAATCCCAGCTACTCGGGAGGCTGAGGCAGGAGAATTGCTTGAACCCAGAAGGTGAAGGTTGCAGTGAGCCAAAATCGCACCATTGCACTCCAGCCTGGGTGACAAGAGAAAGACTCTTATCTTAAAAAAAAAAGAA"


trim_start=2290
chunk_offset=0
start_index=trim_start+chunk_offset-50
end_index=start_index+1000
stride=5
shift=end_index

# prepare some data
x = [0, 1, 2, 3, 4, 5]
Xreal = [0, 1, 2, 3, 4, 5]
y = [6, 7, 2, 4, 5]

# set output to static HTML file
output_file(filename=args.output, title=args.read)

plot_title=f'{read_id}:{start_index}-{end_index}-{trim_start}-{chunk_offset}'
tools_to_show = 'hover,box_zoom,pan,save,wheel_zoom'
p = figure(title=plot_title, 
	x_axis_label='signal index', 
	y_axis_label='signal value', 
	sizing_mode="stretch_width",
    height=300,
    output_backend="webgl",
    x_range=(0, 750),
    tools=tools_to_show)
    # tooltips=tool_tips)


# open file
s5 = pyslow5.Open(args.slow5,'r')
read = s5.get_read(read_id, pA=True, aux=["read_number", "start_mux"])
if read is not None:
    print("read_id:", read['read_id'])
    print("len_raw_signal:", read['len_raw_signal'])
    # x = list(range(1,read['len_raw_signal']+1))
    # y = read['signal']
    x = list(range(0,end_index-start_index))
    Xreal = list(range(start_index,end_index))
    y = read['signal'][start_index:end_index]

base_x = []
base_y = []
base_label = []

vlines = []
move_count = 0
base_count = 0
previous_location = -1
# draw moves
for i in moves:
	location = trim_start+chunk_offset+(move_count*stride)
	location_plot = location - start_index + stride
	if(i == '1'):
		if(previous_location > 0):
			base = bases[base_count]
			
			base_box = BoxAnnotation(left=previous_location, right=location_plot, fill_alpha=0.2, fill_color=base_color_map[base])
			p.add_layout(base_box)
			vline = Span(location=location_plot, dimension='height', line_color='red', line_width=1)
			vlines.append(vline)

			base_x.append(previous_location)
			base_y.append(115)
			label = str(base) + "\t" + str(base_count+1)
			base_label.append(label)
			
			# interval = location - previous_location
			# for j in range(0,interval):
			# 	base_index[(move_count*stride)+j] = base_count

			base_count = base_count + 1
		previous_location = location_plot
	move_count = move_count + 1

p.renderers.extend(vlines)


base_annotation = ColumnDataSource(data=dict(base_x=base_x,
									base_y=base_y,
									base_label=base_label))

base_annotation_labels = LabelSet(x='base_x', y='base_y', text='base_label',
              x_offset=5, y_offset=5, source=base_annotation, render_mode='canvas', text_font_size="7pt")


p.add_layout(base_annotation_labels)


source = ColumnDataSource(data=dict(
	x=x,
    y=y,
    xreal=Xreal,
))
p.line('x', 'y',line_width=2, source=source)

# show the tooltip
hover = p.select(dict(type=HoverTool))
hover.tooltips = [("x","@xreal"),("y", "$y")]
hover.mode = 'mouse'

save(p)
show(p)