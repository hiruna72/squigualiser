from bokeh.plotting import figure, show
from bokeh.models import Span, BoxAnnotation
from bokeh.colors import RGB
import pyslow5

import argparse

parser = argparse.ArgumentParser()
   
parser.add_argument('-o', '--output', action='store_true', help="shows output")
parser.add_argument('-s', '--slow5', required='True', help="shows output")
parser.add_argument('-r', '--read', required='True', help="shows output")

args = parser.parse_args()
print(f'signal file: {args.slow5}')
print(f'read: {args.read}')

read_id = "7a863656-a07d-425b-a3ca-7409a7c14bc1"
start_index=0
end_index=10000
plot_length = end_index - start_index

plot_title=f'{read_id}:{start_index}-{end_index}'
# create a new plot with a title and axis labels
p = figure(title=plot_title, 
	x_axis_label='signal index', 
	y_axis_label='signal value', 
	sizing_mode="stretch_width",
    height=250,
    output_backend="webgl",
    x_range=(3000, 4000))


# prepare some data
x = [1, 2, 3, 4, 5]
y = [6, 7, 2, 4, 5]

base_color_map = {'A':'limegreen','C':'blue','T':'red','G':'orange'}


stride=5
trim_start=2290
moves="1001010101010110101000010100101011011010101000110101010101000101010101001011001011011010101101010100100010110110101010100100101010010010100101010001010110111110101011101001011010101101010001010110101000010010010011010101010101001000010101011010111010111011010110101101001010101011010100000001001011000000100001000101010000010101111010111111010001010110100110110101010010110110101100100101001000110100010101101110110110111011110110110100100101010110110010010010010011000110100001000000000001000001010100001101011011011010101001001001101100101010010101000101101101101111010110101001001011101110111001101101010110111101010010101010000100000001001000000001001010010100010101000011010000100101000100010101101010101010110101010110010101010110111011001010100010011011011011010101010111001101010110111011101111101101010011001001101110101000100101101010111001110010010000101011000001100010101001010010100010000001001010011001010100000001000101010010001000100100010001010100110101000110101101010101010101101010110101001010010100001001101011010101101010101010110101101010101010110010011010101010011101001000000010110000000000000001001010100010100100101101011010100100100101010101001001101011101100011010010101000010101101101010101010101101110110111011000101010110101011010010110011010101101110101101010011000100110110110001001101101101110101110101101011011010100110101011010101010100110100111000101010110111010101001000010000000100101010101010011100010010101011010101010010010010010110110100101010100101101101010101010000100100101001000010100000101101011101011011010100101001010001101101100111001010110000000000"
bases="TACTTCGTTCAGTTACGTATTGCTCCTATAATTGAAGACACTTGTTCTTATACTGCTTTAAGGTATAAAGGAAGAAAAAAAACAGATAATGGCAAATGTTGGTGAAGCCGGGCATGGTGGCAGCCTGTAATTCCAGAACTTAGGGAGGCTGAGGTGGGCAGATCACTTGAGGCCAGGAGTATGAGACCAGCCTGGGCAACATGGTAAAATCCCACCACTACAGAAAAATATAAAAATTAGCCAGGCATGGTGGCGTACACCTGTAATTTTCAGCTACCCAGGAGGCTGAGATGAGAGAATCACTTGTGCCTGGGAGGTCACGGCTGCAGTGAACTGTGATGGCATCATTGCACTGCAGCCTGAGAGACAGAGCAAGCCCCTATCTAGAAAAAAAAAATGTCAGTGAAGATGTGGAGGAATTGGAACCCACATACATTACTGGTGGGAACATAAAATTGTGTAACCATTTTGTTTGGGTATTTTCTTTTCTTGTCATTTAGTGGATTTTTAAAAAATCAAGACGGGGTTTCACTATCTTGCCAGGCTGGTCTTGAATTCCTGAGCTCAAGCCATCCTCCTAGCTGAGCCTCCTGAGTAGCTGGGATTACAGGTGTGAGCCATTGCACCCAACTGAGTATAGCCACGTTAGAAAACATTCTGGCAGTTTCTCAAAAGGCTAAATGTACAGTCATCCTATAATGCAACAATTTCACTCCTAGGCATATGTCCAGAAAAATAAAAATATATG"

# open file
s5 = pyslow5.Open(args.slow5,'r')
read = s5.get_read(read_id, pA=True, aux=["read_number", "start_mux"])
if read is not None:
    print("read_id:", read['read_id'])
    print("len_raw_signal:", read['len_raw_signal'])
    # x = list(range(1,read['len_raw_signal']+1))
    # y = read['signal']
    x = list(range(start_index,end_index))
    y = read['signal'][start_index:end_index]

# draw moves
vlines = []
move_count = 0
base_count = 0
previous_location = -1
for i in moves:
	location = trim_start+(move_count*stride)
	if(i == '1'):
		if(previous_location > 0):
			base = bases[base_count]
			base_box = BoxAnnotation(left=previous_location, right=location, fill_alpha=0.2, fill_color=base_color_map[base])
			p.add_layout(base_box)
			base_count = base_count + 1
			vline = Span(location=location, dimension='height', line_color='cyan', line_width=0.5)
			vlines.append(vline)
		previous_location = location
	move_count = move_count + 1

p.renderers.extend(vlines)

# add a line renderer with legend and line thickness to the plot
p.line(x, y, legend_label="Temp.", line_width=2)

# show the results
show(p)